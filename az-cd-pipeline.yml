trigger:
  batch: true
  branches:
    include:
    - dev
  paths:
    exclude:
    - README.md

pool:
  vmImage: 'ubuntu-latest'

variables:
  jsonFile: google-creds.json
  jsonLocation: /site/wwwroot

steps:
- task: AzureCLI@2
  displayName: Get GOOGLE_APPLICATION_CREDENTIALS from Azure Key Vault
  inputs:
    azureSubscription: 'GreenCity'
    scriptType: 'bash'
    scriptLocation: inlineScript
    inlineScript: |
      az keyvault secret download --name google-credentials --vault-name key-vault-greencity --file $(jsonFile)
      
- task: AzureKeyVault@1
  displayName: Get FTP credentials from Azure Key Vault
  inputs:
    azureSubscription: 'GreenCity'
    KeyVaultName: 'key-vault-greencity'
    SecretsFilter: 'ftpHost, ftpUser, ftpPass'
    
- task: FtpUpload@2
  displayName: Upload json to app service via FTP
  inputs:
    credentialsOption: 'inputs'
    serverUrl: '$(ftpHost)'
    username: '$(ftpUser)'
    password: '$(ftpPass)'
    filePatterns: '$(jsonFile)'
    remoteDirectory: '$(jsonLocation)'

- task: AzureAppServiceSettings@1
  displayName: Set GOOGLE_APPLICATION_CREDENTIALS config in Azure Portal
  inputs:
    azureSubscription: 'GreenCity'
    appName: 'greencity'
    resourceGroupName: 'GreenCity'
    appSettings: |
      [
        {
          "name": "GOOGLE_APPLICATION_CREDENTIALS",
          "value": "$(jsonLocation)/$(jsonFile)", 
          "slotSetting": false
        }
      ]
  
 
- task: Maven@3
  displayName: Maven package
  inputs:
    mavenPomFile: 'pom.xml'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.8'
    mavenVersionOption: 'Default'
    
- script: mv core/target/*.jar core/target/app.jar 
  displayName: Rename core jar to app

- script: mv email/target/*.jar email/target/app.jar 
  displayName: Rename email jar to app

- task: CopyFiles@2
  displayName: Copy Files
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)
    Contents: '**/target/*.jar'
    TargetFolder: $(build.artifactstagingdirectory)

- task: PublishBuildArtifacts@1
  displayName: Publish Artifact
  inputs:
    PathtoPublish: $(build.artifactstagingdirectory)
